---
title: 'Githubã®ãƒ–ãƒ©ãƒ³ãƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ‡ãƒ«ã‚’è§£èª¬ã™ã‚‹'
description: 'Githubã®mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã‚’ã—ãŸå¾Œã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ‡ãƒ«ã§ã¯ãªãã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Œäº†ã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ‡ãƒ«ã‚’è§£èª¬ã—ã¾ã™ã€‚'
date: 2024-02-18
category: github
thumbnail: 'github-branch-deploy.png'
---

## ãƒ–ãƒ©ãƒ³ãƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ‡ãƒ«

Githubã®mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã‚’ã—ãŸå¾Œã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ‡ãƒ«ã§ã¯ãªãã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Œäº†ã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ‡ãƒ«ã‚’è§£èª¬ã—ã¾ã™ã€‚

## PullRequestä¸Šã®ã‚³ãƒãƒ³ãƒ‰ã§Github Actionsã‚’å‹•ä½œã•ã›ã‚‹

Branchãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ‡ãƒ«ã¨èãã¨ã€Œæ–°ã—ã„æ¦‚å¿µãŒå‡ºç¾ã—ãŸã€ã¿ãŸã„ãªèº«æ§‹ãˆã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œãªã„ã€‚ã—ã‹ã—ã€Branchãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ‡ãƒ«ã¯ãŸã Github Actionsã‚’Pull Requestã®ã‚³ãƒ¡ãƒ³ãƒˆã§èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚

ãã®ãŸã‚ã€Pull Requestä¸Šã§è‡ªç”±ã«äº‹å‰ã«è¨­å®šã—ã¦ãŠã„ãŸCICD Workflowã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

ãã®éš›ã«ã€ç’°å¢ƒã‚’æŒ‡å®šã—ã¦CICDã‚’å®Ÿè¡Œã—ãŸã‚Šã€CICDã‚’ãƒ­ãƒƒã‚¯ã—ã¦ä»–ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒåŒæ™‚ã«ãƒªãƒªãƒ¼ã‚¹ã‚’ã™ã‚‹ã“ã¨ãŒãªã„ã‚ˆã†ã«è‡ªç”±ã«è¨­å®šãŒå¯èƒ½ã§ã™ã€‚

ä¸€ã¤ãšã¤è¦‹ã¦ã„ãã€‚

### Pull Requestä¸Šã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã€Github Actionsã‚’èµ·å‹•ã™ã‚‹

ã¾ãšã¯ã€Pull Requestä¸Šã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦Github Actionsã‚’èµ·å‹•ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

`.github/workflows`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚Œã°ã€è‡ªå‹•ã§Github Actionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã ã¨Githubã«èªè­˜ã•ã‚Œã‚‹ã®ã§ã€ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

`demo.yml`
```yaml
name: Demo

# The workflow to execute on is comments that are newly created
on:
  issue_comment:
    types: [created]

# Permissions needed for reacting and adding comments for IssueOps commands
permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  demo:
    runs-on: ubuntu-latest
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0

      - name: Test Run
        run: echo "test run"
```

ã¾ãšã¯ã“ã®ã‚ˆã†ãªYAMLãƒ•ã‚¡ã‚¤ãƒ«ã§å®Ÿé¨“ã‚’ã—ã¦ã¿ã¾ã—ãŸã€‚

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Githubã«Pushã—ã€é©å½“ã«PRãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ã€`.deploy`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/1.png)

ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Github ActionsãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚

![Brach Deploy Model](/images/github-branch-deploy/2.png)

![Brach Deploy Model](/images/github-branch-deploy/3.png)

### PRã‹ã‚‰ã®ã¿ãƒˆãƒªã‚¬ãƒ¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ã“ã®Github Actionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯Issueã‹ã‚‰ã§ã‚‚å®Ÿè¡ŒãŒå¯èƒ½ã§ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Github Issueã‚’ä½œæˆã—ã€ãã®ä¸­ã§`.deploy`ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã™ã‚‹ã¨åŒã˜Github ActionsãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/4.png)

![Brach Deploy Model](/images/github-branch-deploy/5.png)

issueã‹ã‚‰å®Ÿè¡Œã§ãã‚‹ã®ã¯ä¾¿åˆ©ã«è¦‹ãˆã¾ã™ãŒã€ãƒªãƒªãƒ¼ã‚¹ç”¨ã®Workflowã‚’PRä»¥å¤–ã®å ´æ‰€ã‹ã‚‰ãƒˆãƒªã‚¬ãƒ¼ã§ãã¦ã—ã¾ã†ã®ã¯å±é™ºã§ã™ã€‚

ãã®ãŸã‚ã€Pull Reqestã‹ã‚‰ã®ã¿ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ifæ–‡ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`demo.yml`
```yaml
name: Demo

# The workflow to execute on is comments that are newly created
on:
  issue_comment:
    types: [created]

# Permissions needed for reacting and adding comments for IssueOps commands
permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  demo:
    # ã“ã“ã‚’è¿½åŠ 
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0

      - name: Test Run
        run: echo "test run"
```

`if`æ–‡ã‚’è¿½åŠ ã—ãŸãŠã‹ã’ã§ã€Issueã®ä¸­ã§å†åº¦`.deploy`ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ã‚‚WorkflowãŒSkipã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![Brach Deploy Model](/images/github-branch-deploy/6.png)

â€»ä¸€ç•ªä¸Šã®`aa`ã¨ã„ã†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒç„¡è¦–ã•ã‚Œã¦ã„ã‚‹ã€‚

### noop deployã‚’å®Ÿè£…ã™ã‚‹

æ¬¡ã«`noop deploy`ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

`noop`ã¨ã¯`No Operaion`ã®è¨³ã§ã€ä½•ã‚‚å®Ÿè¡Œã‚’ã—ãªã„ã•ã„ã«ä½¿ã‚ã‚Œã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

ä¾‹ãˆã°ã€`Terraform Plan`ã®ã‚ˆã†ãªå®Ÿè¡Œã‚’ã—ãŸã¨ã—ã¦ã‚‚ç’°å¢ƒã«ã¯å¤‰æ›´ãŒãªã„ã‚ˆã†ãªã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒè©²å½“ã—ã¾ã™ã€‚

å…ˆã»ã©ä½œæˆã—ãŸ`demo.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã«`noop deploy`ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

`demo.yml`
```yaml
name: Demo

# The workflow to execute on is comments that are newly created
on:
  issue_comment:
    types: [created]

# Permissions needed for reacting and adding comments for IssueOps commands
permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  demo:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0

      - name: Test Run
        run: echo "test run"

      - name: Noop Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop == 'true' }}
        run: echo "Noop Deploy!"
```

ä¸€ç•ªæœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦`Noop Deploy`ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã“ã®Stepã‚’è¿½åŠ ã—ãŸWorkflowã‚’Githubã«è¿½åŠ ã—ãŸå¾Œã€`.noop`ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/7.png)

![Brach Deploy Model](/images/github-branch-deploy/8.png)

ã™ã‚‹ã¨ã€ã“ã®ã‚ˆã†ã«`Noop Deploy`ã§è¨­å®šã—ãŸStepãŒGithub Actionsä¸Šã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

#### .deployã‚³ãƒãƒ³ãƒ‰ã§Noop DeployãŒå®Ÿè¡Œã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹

`.deploy`ã‚³ãƒãƒ³ãƒ‰ã§`Noop Deploy`ãŒå®Ÿè¡Œã•ã‚Œãªã„ã“ã¨ã‚‚ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/9.png)

![Brach Deploy Model](/images/github-branch-deploy/10.png)

ã“ã®ã‚ˆã†ã«`.deploy`ã‚³ãƒãƒ³ãƒ‰ã®æ™‚ã¯`Noop Deploy`ã‚¹ãƒ†ãƒƒãƒ—ãŒSkipã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

### Deployã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®ã¿ã®Stepã‚’è¿½åŠ ã™ã‚‹

å…ˆã»ã©ã¯`.noop`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸæ™‚ã«ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ã€`.deploy`ã®æ™‚ã®ã¿ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

`demo.yml`
```yaml
name: Demo

# The workflow to execute on is comments that are newly created
on:
  issue_comment:
    types: [created]

# Permissions needed for reacting and adding comments for IssueOps commands
permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  demo:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0

      - name: Test Run
        run: echo "test run"

      - name: Noop Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop == 'true' }}
        run: echo "Noop Deploy!"

      - name: Regular Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop != 'true' }}
        run: echo "Regular Deploy!"

```

æœ€çµ‚è¡Œã«`.deploy`ã‚³ãƒãƒ³ãƒ‰ã®æ™‚ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹Stepã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

ã“ã®çŠ¶æ…‹ã§`.deploy`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/11.png)

![Brach Deploy Model](/images/github-branch-deploy/12.png)

ã™ã‚‹ã¨ã€ä¸Šè¨˜ã®ã‚ˆã†ã«æ­£å¸¸ã«æŒ‡å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

## ç’°å¢ƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹

åŸºæœ¬çš„ãªBranch Deployãƒ¢ãƒ‡ãƒ«ã«é–¢ã™ã‚‹è§£èª¬ã¯å®Œäº†ã—ã¾ã—ãŸã€‚

æ¬¡ã«ã€Branch Deployã®Enviromentã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€è¤‡æ•°ç’°å¢ƒã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

### Deployã‚³ãƒãƒ³ãƒ‰ã§ç’°å¢ƒã‚’æŒ‡å®šã™ã‚‹

ã“ã“ã¾ã§ã§è§£èª¬ã—ãŸã‚ˆã†ã«ã€Branch Deployãƒ¢ãƒ‡ãƒ«ã§ã¯`.deploy` or `.noop`ã‚³ãƒãƒ³ãƒ‰ã«ã¦Github Actionsã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã®å¾Œã‚ã«ç’°å¢ƒåã‚’è¿½è¨˜ã™ã‚‹ã“ã¨ã§ã€ç‰¹å®šã®ç’°å¢ƒã«å¯¾ã—ã¦Github Actionsã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

`.deploy staging`ã®å…¥åŠ›ã—ãŸå ´åˆã¯`staging`ç’°å¢ƒã«å¯¾ã—ã¦ãƒªãƒªãƒ¼ã‚¹ãŒè¡Œã‚ã‚Œã€`.noop production`ã¨å…¥åŠ›ã—ãŸå ´åˆã¯`production`ç’°å¢ƒã«å¯¾ã—ã¦`noop`ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

â€»ç’°å¢ƒåã‚’æŒ‡å®šã—ãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯`production`ã®ãŸã‚ã€ä»Šã¾ã§å®Ÿè¡Œã—ã¦ã„ãŸ`.deploy`ã‚„`.noop`ã¯`.deploy production`ã¨`.noop production`ã‚’å®Ÿè¡Œã—ã¦ã„ãŸã®ã¨åŒã˜ã«ãªã‚Šã¾ã™ã€‚

### Deployã‚³ãƒãƒ³ãƒ‰ã®ç’°å¢ƒåã”ã¨ã«å‡¦ç†ã‚’å¤‰ãˆã‚‹

ãã‚Œã§ã¯ã€ã‚³ãƒãƒ³ãƒ‰ã§ç’°å¢ƒåã‚’æŒ‡å®šã—ãŸã¨ãã«å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å¤‰ãˆã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`demo.yml`
```yaml
name: Demo

# The workflow to execute on is comments that are newly created
on:
  issue_comment:
    types: [created]

# Permissions needed for reacting and adding comments for IssueOps commands
permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  demo:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0

      - name: Test Run
        run: echo "test run"

      - name: Noop Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop == 'true' }}
        run: echo "Noop Deploy!"

      - name: Regular Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop != 'true' }}
        run: echo "Regular Deploy!"

      - name: Production Noop Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop == 'true' && steps.branch-deploy.outputs.environment == 'production' }}
        run: echo "Production Noop Deploy!"

      - name: Production Regular Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop != 'true' && steps.branch-deploy.outputs.environment == 'production' }}
        run: echo "Production Regular Deploy!"

      - name: Staging Noop Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop == 'true' && steps.branch-deploy.outputs.environment == 'staging' }}
        run: echo "Staging Noop Deploy!"

      - name: Staging Regular Deploy
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.branch-deploy.outputs.noop != 'true' && steps.branch-deploy.outputs.environment == 'staging' }}
        run: echo "Staging Regular Deploy!"
```

- Production Noop Deploy
- Production Regular Deploy
- Staging Noop Deploy
- Staging Regular Deploy

ã®4ã¤ã®æ¡ä»¶åˆ†å²ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

ã“ã®çŠ¶æ…‹ã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ã¾ã™ã€‚

`.deploy production`
![Brach Deploy Model](/images/github-branch-deploy/13.png)

`.noop production`
![Brach Deploy Model](/images/github-branch-deploy/14.png)

`.deploy staging`
![Brach Deploy Model](/images/github-branch-deploy/15.png)

`.noop staging`
![Brach Deploy Model](/images/github-branch-deploy/16.png)

ãã‚Œãã‚Œã®ã‚³ãƒãƒ³ãƒ‰æ¯ã®Github Actionsã®å®Ÿè¡Œçµæœã§ã™ã€‚

ç’°å¢ƒã¨noopã®çµ„ã¿åˆã‚ã›ã§ãã‚Œãã‚Œç•°ãªã‚‹StepãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ï¼

## Githubã®Environmentã¨Branch Deployã®Environment

Githubã‚’é•·å¹´ä½¿ã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰ã°ã€Githubè‡ªä½“ã®Environmentã‚’åˆ©ç”¨ã—ãŸã“ã¨ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment

ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã†ã¨ã€ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹Secretã‚„ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã§ãã‚‹ãŸã‚å¤šãã®ç’°å¢ƒã‚’é‹ç”¨ã—ã¦ã„ã‚‹é–‹ç™ºãƒãƒ¼ãƒ ã«ã¨ã£ã¦éå¸¸ã«ä½¿ã„ã‚„ã™ã„æ©Ÿèƒ½ã§ã™ã€‚

ã“ã®Environmentã¯Branch Deployã®Environmentã¨ã¯åˆ¥ç‰©ã§ã™ã€‚ãã®ãŸã‚ã€Branch Deployä¸Šã§ç’°å¢ƒåã‚’æŒ‡å®šã—ãŸã¨ã—ã¦ã‚‚Githubä¸Šã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹Environmentã®ç’°å¢ƒã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

Githubä¸Šã®Environmentã‚’æŒ‡å®šã—ãŸã„å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«Github Actionsã®jobæ¯ã«è¨­å®šã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

`demo.yml`
```yaml
name: Demo

# The workflow to execute on is comments that are newly created
on:
  issue_comment:
    types: [created]

# Permissions needed for reacting and adding comments for IssueOps commands
permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  demo:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    # ã“ã“ã‚’è¿½åŠ 
    environment: production
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0
...
```

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§Githubã®Environmentã®`production`ç’°å¢ƒã«è¨­å®šã—ã¦ã„ã‚‹Secretã‚„Variablesã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### Environmentã®å•é¡Œç‚¹

Branch Deployãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ä¸Šã§å•é¡Œã¨ãªã‚‹ã®ã¯ã€Branch Deployãƒ¢ãƒ‡ãƒ«ã®ç’°å¢ƒã¨Githubè‡ªä½“ã®ç’°å¢ƒãŒåŒã˜ã«ãªã‚‰ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚

ä¾‹ãˆã°ã€

`demo.yml`
```yaml
...
jobs:
  demo:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0

      - name: Echo TEST Environment Variable
        run: echo ${{ vars.TEST }}
```

ã“ã®ã‚ˆã†ãªGithub ActionsãŒã‚ã£ãŸå ´åˆã€`.deploy staging`ã‚’å®Ÿè¡Œã—ã¦ã‚‚`.deploy production`ã‚’æŒ‡å®šã—ã¦ã‚‚ã€`vars.TEST`ã«å…¥ã‚‹ç’°å¢ƒå¤‰æ•°ã¯Githubã®`production`ç’°å¢ƒã®`TEST`å¤‰æ•°ã§ã™ã€‚Githubã®`staging`ç’°å¢ƒã®`TEST`å¤‰æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã«ã¯2ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

#### ç’°å¢ƒå¤‰æ•°ç”¨ã®ç’°å¢ƒã‚’ä½œæˆã™ã‚‹

1ã¤ç›®ã¯ç’°å¢ƒå¤‰æ•°ç”¨ã®ç’°å¢ƒã‚’åˆ¥é€”ç”¨æ„ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

ã“ã®æ–¹æ³•ã§ã¯ã€`secrets`ã®ã‚ˆã†ãªGithubã®ç’°å¢ƒã‚’äº‹å‰ã«ç”¨æ„ã—ã¾ã™ã€‚

ãã®ä¸Šã§ã€ãã®`secrets`ã®ä¸­ã«`PRODUCTION_TEST`ãƒ»`STAGING_TEST`ãªã©ã®Branch Deployãƒ¢ãƒ‡ãƒ«ã®ç’°å¢ƒåãŒä»˜ä¸ã•ã‚ŒãŸå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚

ãã‚Œã‚‰ã®å¤‰æ•°ã‚’æ¡ä»¶åˆ†å²æ¯ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Branch Deployãƒ¢ãƒ‡ãƒ«ã®ä¸­ã§ç’°å¢ƒå¤‰æ•°ã¨Secretã‚’ä½¿ã„ã¾ã™ã€‚

#### Branch Deployãƒ¢ãƒ‡ãƒ«ã®çµæœã‚’æ¬¡ã®jobã«å¼•ãæ¸¡ã™

2ã¤ç›®ã®æ–¹æ³•ã¯ã€Branch Deployã®ç’°å¢ƒåã‚’`output`ã¨ã—ã¦å‡ºåŠ›ã—ã€ãã‚Œã‚’Githubã®`environment`ã«æ¸¡ã™ã‚„ã‚Šæ–¹ã§ã™ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`demo.yml`
```yaml
name: Demo

# The workflow to execute on is comments that are newly created
on:
  issue_comment:
    types: [created]

# Permissions needed for reacting and adding comments for IssueOps commands
permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  trigger:
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    environment: production
    outputs:
      environment: ${{ steps.branch-deploy.outputs.environment }}
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0
  result:
    needs: [trigger]
    runs-on: ubuntu-latest
    environment: ${{ needs.trigger.outputs.environment }}
    steps:
      - name: Env Test
        run: echo ${{ vars.TEST }}
```

`trigger`ã‚¸ãƒ§ãƒ–ã§ç¾åœ¨ã®Branch Deployã®ç’°å¢ƒã‚’å–å¾—ã—ã€`result`ã‚¸ãƒ§ãƒ–ã§å®Ÿéš›ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

ã“ã†ã™ã‚‹ã“ã¨ã§ã€`result`ã‚¸ãƒ§ãƒ–ã¯Branch Deployã§æŒ‡å®šã—ãŸç’°å¢ƒåã§ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€Githubã®`Environment`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## Branch Deployãƒ¢ãƒ‡ãƒ«ã®Parameter

Branch Deployãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹éš›ã«Pull Requestã‹ã‚‰Workflowã«å¯¾ã—ã¦è‡ªç”±ã«å€¤ã‚’æ¸¡ã—ãŸããªã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

ãã‚“ãªæ™‚ã¯Branch Deployãƒ¢ãƒ‡ãƒ«ã®Parameterã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€è‡ªç”±ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### param_separatorã‚ªãƒ—ã‚·ãƒ§ãƒ³

https://github.com/github/branch-deploy/blob/main/docs/parameters.md

ä¸Šè¨˜å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚ˆã†ã«ã€Github Branch Deployãƒ¢ãƒ‡ãƒ«ã§ã¯ã€`param_separator`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§è‡ªç”±ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’Workflowã«å¼•ãæ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

`demo.yml`
```yaml
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0
        with:
          environment_targets: staging-demo,production-demo
          param_separator: "|"
```

ã¨æŒ‡å®šã—ãŸå ´åˆã€`|`ã®å¾Œã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’Workflowã«å¼•ãæ¸¡ã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ä¾‹ãˆã°`.deploy staging-demo | aaa bbb ccc`ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå ´åˆã€`params`ã«ã¯`aaa bbb ccc`ã¨ã„ã†å€¤ãŒå…¥ã‚Šã¾ã™ã€‚

ãã—ã¦ã€ãã®å€¤ã‚’`steps.branch-deploy.outputs.params`ã«ã¦Workflowä¸Šã§å–å¾—ã§ãã¾ã™ã€‚

#### Parameterã‚’æŒ‡å®šã—ã¦Workflowã‚’å®Ÿè¡Œã™ã‚‹

å®Ÿéš›ã«Parameterã‚’æŒ‡å®šã—ã¦Workflowã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

`demo.yml`
```yaml
    steps:
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0
        with:
          environment_targets: staging-demo,production-demo

      - name: example
        if: steps.branch-deploy.outputs.continue == 'true'
        run: |
          echo "params: ${{ steps.branch-deploy.outputs.params }}"
```

ã“ã®ã‚ˆã†ã«æŒ‡å®šã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’echoã§logã«è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Pull Requestä¸Šã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/17.png)

ã™ã‚‹ã¨ã€Github Actionsä¸Šã®`branch-deploy`ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯`ğŸ§® detected parameters in command: aaa bbb ccc`ã¨ã„ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã“ã¨ã‚’ç¤ºã™ãƒ­ã‚°ãŒå‡ºã¦ã„ã¾ã™ã€‚

ã¾ãŸã€`exmaple`ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã§ã¯ã€æŒ‡å®šã—ãŸé€šã‚Š`aaa bbb ccc`ã¨ã„ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/18.png)

### Key=Valueå½¢å¼ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æŒ‡å®šãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€è¤‡æ•°ã®ç¨®é¡ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`CPU=4`, `MEMORY=2000`ã¨ã„ã£ãŸå…·åˆã«Key=Valueå½¢å¼ã§è¤‡æ•°ã®ç¨®é¡ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ãŸã„å ´åˆ

`.deploy staging-demo | CPU=4,MEMORY=2000`

ã¨ã„ã£ãŸå…·åˆã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸­ã§`,`ç­‰ã®ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¾ã™ã€‚

ãã®separaterã‚’ç›®å°ã«Github Actionsä¸Šã§å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚

`demo.yml`
```yaml
      - name: branch-deploy
        id: branch-deploy
        uses: github/branch-deploy@v9.0.0
        with:
          environment_targets: staging-demo,production-demo

      - name: Parse Branch Deploy Parameter
        if: steps.branch-deploy.outputs.continue == 'true'
        id: parse-parameter
        run: |
          paramString="${{ steps.branch-deploy.outputs.params }}"
          IFS=', ' read -r -a pairs <<< "$paramString"
          for pair in "${pairs[@]}"
          do
            IFS='=' read -r key value <<< "$pair"
            echo "::set-output name=$key::$value"
          done

      - name: CPU Value
        if: steps.branch-deploy.outputs.continue == 'true'
        run: echo ${{ steps.parse-parameter.outputs.CPU }}
      - name: MEMORY Value
        if: steps.branch-deploy.outputs.continue == 'true'
        run: echo ${{ steps.parse-parameter.outputs.MEMORY }}
```

ã“ã®ã‚ˆã†ã«YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã™ã‚‹ã¨ã€Parameterã¨ã—ã¦æŒ‡å®šã—ãŸ`CPU`ã¨`MEMORY`ã‚’ãã‚Œãã‚Œå–å¾—ã§ãã¾ã™ã€‚

è©¦ã—ã«ä¸Šè¨˜YAMLãƒ•ã‚¡ã‚¤ãƒ«ã§å‹•ä½œã™ã‚‹Github Actionsã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/19.png)

`.deploy staging-demo | CPU=4,MEMORY=2000`ã¨ã„ã†ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã€Github Actionsã‚’èµ·å‹•ã—ã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/20.png)

æ­£å¸¸ã«å‹•ä½œã™ã‚Œã°ã€ä¸Šè¨˜ã®ã‚ˆã†ã«ãã‚Œãã‚Œã®Parameterã‚’å–å¾—ã§ãã¾ã™ã€‚

#### ParameterãŒå­˜åœ¨ã—ãªã„å ´åˆStepã‚’Skipã™ã‚‹

CPUã¨MEMORYã‚’æŒ‡å®šã§ãã‚‹Github Actionsã‚’ä½œæˆã—ã¾ã—ãŸãŒã€ç‰‡æ–¹ã—ã‹æŒ‡å®šã—ãªã„ã“ã¨ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

å€¤ãŒãªã„å ´åˆã¯ã€ãã®å€¤ã‚’ä½¿ã†Stepã‚’Skipã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

`demo.yml`
```yaml
      - name: CPU Value
        if: ${{ steps.branch-deploy.outputs.continue == 'true' && steps.parse-parameter.outputs.CPU != '' }}
        run: echo ${{ steps.parse-parameter.outputs.CPU }}
```

ã“ã®ã‚ˆã†ã«`CPU`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯SKIPã™ã‚‹å‡¦ç†ã‚’`CPU Value`Stepã«è¿½åŠ ã—ã¦ã€ãƒ¡ãƒ¢ãƒªã ã‘ã‚’æŒ‡å®šã—ãŸ`.deploy staging-demo | MEMORY=2000`ã‚³ãƒ¡ãƒ³ãƒˆã‚’PRã«è¿½åŠ ã—ã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/21.png)

ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«`CPU Value`ã‚’Skipã—ãŸWorkflowãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

![Brach Deploy Model](/images/github-branch-deploy/22.png)


## ã¾ã¨ã‚

Githubã®Branch Deployãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚

Merge Deployãƒ¢ãƒ‡ãƒ«ã®æ–¹ãŒå¤šãæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹å°è±¡ãŒã‚ã‚Šã¾ã™ãŒã€Branch Deployãƒ¢ãƒ‡ãƒ«ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã§CICDãŒæ­£å¸¸å‹•ä½œã‚’ã—ãŸã“ã¨ã‚’æ‹…ä¿ã§ãã‚‹ã®ã§`main`ãƒ–ãƒ©ãƒ³ãƒã‚’å®Œå…¨ãªçŠ¶æ…‹ã«ä¿ã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

Terraformã®ã‚ˆã†ãªIaCãƒ„ãƒ¼ãƒ«ã‚’ç®¡ç†ã™ã‚‹Github Repositoryã¨ã¨ã¦ã‚‚ç›¸æ€§ãŒã„ã„ãƒ¢ãƒ‡ãƒ«ã§ã™ã®ã§ã€ãœã²ã€åˆ©ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
